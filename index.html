<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meus Investimentos</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f4f4f4;
      overscroll-behavior-y: contain; /* ajuda no pull-to-refresh customizado */
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 12px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 16px;
    }
    label {
      font-size: 0.85rem;
      display: block;
      margin-bottom: 4px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    #addBtn {
      background: #0f766e;
      color: #fff;
      width: 100%;
      margin-top: 4px;
    }
    #addBtn:active {
      opacity: 0.8;
    }

    .secondary-btn {
      background: #e5e7eb;
      font-size: 0.8rem;
      padding: 8px 12px;
      border-radius: 999px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      min-width: 700px;
    }
    th, td {
      padding: 6px;
      text-align: left;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
    }
    .table-container {
      overflow-x: auto;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
    }
    .tipo-renda_fixa { background: #e0f2fe; }
    .tipo-fundo      { background: #fef9c3; }
    .tipo-cripto     { background: #fee2e2; }
    .tipo-acao       { background: #dcfce7; }

    .totais span {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }
    .danger-btn {
      background: #fee2e2;
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 999px;
    }

    /* Abas */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      border-radius: 999px;
      border: 1px solid #d4d4d8;
      background: #f4f4f5;
      font-size: 0.9rem;
    }
    .tab-btn.active {
      background: #0f766e;
      color: #fff;
      border-color: #0f766e;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    .status {
      font-size: 0.8rem;
      margin-bottom: 6px;
      color: #4b5563;
    }
    .status.error {
      color: #b91c1c;
    }
    .status.success {
      color: #15803d;
    }

    /* Mensagem visual do pull-to-refresh */
    #ptr-message {
      text-align: center;
      padding: 10px;
      font-size: 0.8rem;
      color: #6b7280;
      display: none;
    }
  </style>

<style>
/* modal overlay */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.modal-hidden { display: none; }
.modal-content {
  background: #fff;
  border-radius: 12px;
  padding: 18px;
  width: min(420px, 96%);
  box-shadow: 0 12px 40px rgba(0,0,0,0.25);
}
.modal-content input { width:100%; padding:8px; margin-top:6px; border-radius:8px; border:1px solid #ddd; }
.modal-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
.primary-btn { background:#064e3b; color:white; border:none; padding:8px 12px; border-radius:8px; }
.secondary-btn { background:#e6e6e6; border:none; padding:8px 10px; border-radius:8px; }
#appOverlayBlocker { position:fixed; inset:0; background:rgba(255,255,255,0.85); z-index:900; display:none; }
</style>


</head>
<body>

  <!-- Mensagem do pull-to-refresh -->
  <div id="ptr-message">‚Üª Solte para atualizar a p√°gina...</div>

  <h1>Meus Investimentos</h1>
  
  
  <!-- Abas -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="cadastro">Cadastro</button>
    <button class="tab-btn" data-tab="lancamentos">Lan√ßamentos</button>
  </div>

  <!-- ABA CADASTRO -->
  <div id="tab-cadastro" class="tab-content active">
    <div class="card">
      <h2 style="font-size:1rem; margin-top:0;">Novo lan√ßamento</h2>

      <label for="tipo">Tipo</label>
      <select id="tipo">
        <option value="renda_fixa">Renda fixa</option>
        <option value="fundo">Fundo (FII/ETF/Fundo)</option>
        <option value="cripto">Criptoativo</option>
        <option value="acao">A√ß√£o</option>
      </select>

      <label for="ticker">Ticker / C√≥digo (para pre√ßo e valida√ß√£o)</label>
      <input id="ticker" placeholder="Ex.: PETR4, IVVB11, BTC, ETH..." />

      <label for="nome">Nome do ativo (deixa em branco para preencher autom√°tico)</label>
      <input id="nome" placeholder="Se vazio, usa o nome retornado pela API" />

      <label for="corretora">Corretora / Banco</label>
      <select id="corretora">
        <option value="Nubank">Nubank</option>
        <option value="XP">XP</option>
        <option value="BTG Pactual">BTG Pactual</option>
        <option value="Mercado Bitcoin">Mercado Bitcoin</option>
      </select>

      <label for="valor">Valor aplicado total (R$)</label>
      <input id="valor" type="number" step="0.01" inputmode="decimal" />

      <label for="quantidade">Quantidade de cotas/moedas</label>
      <input id="quantidade" type="number" step="0.0001" inputmode="decimal" />

      <label for="preco">Pre√ßo atual (R$) ‚Äì opcional, ser√° atualizado depois</label>
      <input id="preco" type="number" step="0.01" inputmode="decimal" />

      <button id="addBtn">Adicionar</button>
    </div>
  </div>

  <!-- ABA LAN√áAMENTOS -->
  <div id="tab-lancamentos" class="tab-content">
    <div class="card">
      <div class="status" id="status"></div>
      <button id="updatePricesBtn" class="secondary-btn">Atualizar pre√ßos de mercado</button>
    </div>

    <div class="card">
      <h2 style="font-size:1rem; margin-top:0;">Totais</h2>
      <div class="totais" id="totais"></div>
    </div>

    <div class="card">
      <h2 style="font-size:1rem; margin-top:0;">Lan√ßamentos</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Ticker</th>
              <th>Ativo</th>
              <th>Corretora</th>
              <th>Qtd</th>
              <th>Pre√ßo m√©dio</th>
              <th>Pre√ßo atual</th>
              <th>Aplicado</th>
              <th>Valor atual</th>
              <th>P/L %</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="lista"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Rodap√© com vers√£o da aplica√ß√£o -->
  <footer id="footerAtualizacao" style="
    text-align:center;
    font-size:0.75rem;
    color:#6b7280;
    margin-top:20px;
    padding-top:10px;
    border-top:1px solid #e5e7eb;
  ">
    √öltima vers√£o da aplica√ß√£o: carregando...
  </footer>
 <!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>
<!-- LOGIN MODAL (bloqueia acesso) -->
<div id="loginModal" class="modal-overlay modal-hidden" role="dialog" aria-modal="true">
  <div class="modal-content" role="document">
    <h3>Entrar</h3>
    <p style="color:var(--muted); margin:6px 0 10px 0;">Fa√ßa login para acessar seus investimentos. A senha √© usada para derivar a chave de criptografia localmente.</p>

    <label for="modalLoginUserId">Usu√°rio</label>
    <input id="modalLoginUserId" autocomplete="username"/>

    <label for="modalLoginPassword">Senha</label>
    <input id="modalLoginPassword" type="password" autocomplete="current-password"/>

    <div style="font-size:0.85rem; color:var(--muted); margin-top:8px;">
      Sem armazenamento de senha no navegador ‚Äî a chave √© derivada temporariamente (mais seguro).
    </div>

    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
      <button id="modalCancelBtn" class="secondary-btn">Sair</button>
      <button id="modalLoginBtn" class="primary-btn">Entrar</button>
    </div>
  </div>
</div>

<script>
/* =================================================
   HTML+JS app completo ‚Äî D (secure, modal login)
   Ajuste: mudar PROXY_BASE_URL abaixo para seu Worker
   ================================================= */

///////////////////// CONFIG /////////////////////
const APP_VERSION = "v1.0 ‚Äî secure";
const PROXY_BASE_URL = "https://proxy-brapi.dionatan-sgs.workers.dev"; // <-- ajuste aqui
const SESSION_STORAGE_KEY = "meus_investimentos_session";
const USER_ID_STORAGE_KEY = "meus_investimentos_user_id";
const STORAGE_KEY_ENC = "meus_investimentos_encrypted_cache_v1";
//////////////////////////////////////////////////

/* estado */
let sessionToken = localStorage.getItem(SESSION_STORAGE_KEY) || "";
let currentUserId = localStorage.getItem(USER_ID_STORAGE_KEY) || "";
let cryptoKey = null;        // CryptoKey em mem√≥ria (AES-GCM)
let investimentos = [];      // dados em claro em mem√≥ria

/* UI helpers */
const toastEl = document.getElementById("toast");
function toast(msg, time=2500){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), time);
}
function setStatus(msg, type=""){
  const el = document.getElementById("status");
  if(!el) return;
  el.textContent = msg || "";
  el.className = "status " + (type||"");
}
function showModal(){ document.getElementById("loginModal").classList.remove("modal-hidden"); document.getElementById("appOverlayBlocker").style.display="block"; document.getElementById("modalLoginUserId").focus(); }
function hideModal(){ document.getElementById("loginModal").classList.add("modal-hidden"); document.getElementById("appOverlayBlocker").style.display="none"; }

/* ====== crypto helpers (PBKDF2 -> AES-GCM) ====== */
function hexToUint8(hex){
  if(!hex) return new Uint8Array();
  const u8 = new Uint8Array(hex.length/2);
  for(let i=0;i<u8.length;i++) u8[i]=parseInt(hex.substr(i*2,2),16);
  return u8;
}
function uint8ToBase64(u8){
  let s="";
  for(let i=0;i<u8.length;i++) s += String.fromCharCode(u8[i]);
  return btoa(s);
}
function base64ToUint8(b64){
  const s = atob(b64);
  const u8 = new Uint8Array(s.length);
  for(let i=0;i<s.length;i++) u8[i]=s.charCodeAt(i);
  return u8;
}
async function deriveKey(password, saltHex){
  const enc = new TextEncoder();
  const passKey = await crypto.subtle.importKey("raw", enc.encode(password), {name:"PBKDF2"}, false, ["deriveKey"]);
  const salt = hexToUint8(saltHex);
  const key = await crypto.subtle.deriveKey(
    { name: "PBKDF2", hash:"SHA-256", salt, iterations: 200000 },
    passKey,
    { name: "AES-GCM", length: 256 },
    false,
    ["encrypt","decrypt"]
  );
  return key;
}
async function encryptJson(obj){
  if(!cryptoKey) throw new Error("Chave n√£o derivada");
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const encoder = new TextEncoder();
  const plain = encoder.encode(JSON.stringify(obj));
  const cipher = await crypto.subtle.encrypt({ name:"AES-GCM", iv }, cryptoKey, plain);
  const combined = new Uint8Array(iv.byteLength + cipher.byteLength);
  combined.set(iv,0);
  combined.set(new Uint8Array(cipher), iv.byteLength);
  return uint8ToBase64(combined); // string
}
async function decryptJson(b64){
  if(!cryptoKey) throw new Error("Chave n√£o derivada");
  const all = base64ToUint8(b64);
  const iv = all.slice(0,12);
  const data = all.slice(12);
  const plain = await crypto.subtle.decrypt({ name:"AES-GCM", iv }, cryptoKey, data);
  const dec = new TextDecoder();
  return JSON.parse(dec.decode(plain));
}

/* ====== API calls ====== */
async function apiLogin(userId, password){
  const resp = await fetch(`${PROXY_BASE_URL}/auth/login`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ userId, password })
  });
  const j = await resp.json().catch(()=>({}));
  if(!resp.ok) throw new Error(j.error || "Erro no login");
  return j; // {ok, sessionId, user:{id,name}, encryptionSalt}
}
async function apiGetData(){
  const resp = await fetch(`${PROXY_BASE_URL}/data`, {
    headers: { Authorization:`Bearer ${sessionToken}` }
  });
  if(!resp.ok) throw new Error("Erro ao buscar dados na nuvem");
  const j = await resp.json().catch(()=>({}));
  return j; // {ok:true, userId, data: "base64string" | null}
}
async function apiPostData(encryptedString){
  const resp = await fetch(`${PROXY_BASE_URL}/data`, {
    method:"POST",
    headers: { "Content-Type":"text/plain", Authorization:`Bearer ${sessionToken}` },
    body: encryptedString
  });
  if(!resp.ok) throw new Error("Erro ao salvar dados na nuvem");
  return await resp.json().catch(()=>({}));
}

/* ====== Pre√ßos (cripto/coingecko + BRAPI via proxy) ====== */
const MAPA_CRIPTO = { BTC:{id:"bitcoin", nome:"Bitcoin"}, ETH:{id:"ethereum", nome:"Ethereum"}, SOL:{id:"solana", nome:"Solana"}, ADA:{id:"cardano", nome:"Cardano"}, XRP:{id:"ripple", nome:"XRP"}, BNB:{id:"binancecoin", nome:"BNB"} };

async function buscarPrecoCripto(ticker){
  const up = ticker.toUpperCase().trim();
  const info = MAPA_CRIPTO[up];
  if(!info) return { valido:false };
  try{
    const resp = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(info.id)}&vs_currencies=brl`);
    if(!resp.ok) return { valido:false };
    const data = await resp.json();
    const valor = data[info.id]?.brl;
    return { valido: typeof valor === "number", preco: valor, nomeApi: info.nome };
  }catch(e){ console.error(e); return { valido:false }; }
}

async function buscarPrecoAcaoOuFundo(ticker){
  const clean = ticker.toUpperCase().trim();
  try{
    const resp = await fetch(`${PROXY_BASE_URL}/quote?symbol=${encodeURIComponent(clean)}`);
    if(!resp.ok) return { valido:false };
    const data = await resp.json().catch(()=>({}));
    const r = data.results && data.results[0];
    if(!r || typeof r.regularMarketPrice !== "number") return { valido:false };
    return { valido:true, preco: r.regularMarketPrice, nomeApi: r.longName || r.shortName || clean };
  }catch(e){ console.error(e); return { valido:false }; }
}

/* ====== Render / helpers UI ====== */
function formatCurrency(v){ if(v==null||isNaN(v)) return "-"; return v.toLocaleString("pt-BR",{style:"currency", currency:"BRL"}); }
function formatPercent(v){ if(v==null||isNaN(v)) return "-"; return v.toFixed(2).replace(".",",")+" %"; }
function labelTipo(tipo){ switch(tipo){ case "renda_fixa": return "Renda fixa"; case "fundo": return "Fundo"; case "cripto": return "Cripto"; case "acao": return "A√ß√£o"; default: return tipo; } }

function render(){
  const tbody = document.getElementById("lista");
  tbody.innerHTML = "";
  const totais = { renda_fixa:{aplicado:0,atual:0}, fundo:{aplicado:0,atual:0}, cripto:{aplicado:0,atual:0}, acao:{aplicado:0,atual:0} };
  investimentos.forEach((inv, index) => {
    const valorAplicado = inv.valor || 0;
    const quantidade = inv.quantidade || 0;
    const precoAtual = inv.preco || 0;
    const valorAtual = (quantidade && precoAtual) ? (quantidade * precoAtual) : (precoAtual || valorAplicado);
    const precoMedio = (quantidade && valorAplicado) ? (valorAplicado / quantidade) : (valorAplicado || null);
    const plValor = (valorAtual || 0) - (valorAplicado || 0);
    const plPercent = valorAplicado ? (plValor / valorAplicado) * 100 : null;
    if(totais[inv.tipo]) { totais[inv.tipo].aplicado += valorAplicado; totais[inv.tipo].atual += valorAtual; }

    const tr = document.createElement("tr");
    const tdTipo = document.createElement("td"); const span = document.createElement("span"); span.textContent = labelTipo(inv.tipo); span.className = "badge tipo-" + inv.tipo; tdTipo.appendChild(span);
    const tdTicker = document.createElement("td"); tdTicker.textContent = inv.ticker || "-";
    const tdNome = document.createElement("td"); tdNome.textContent = inv.nome || "-";
    const tdCor = document.createElement("td"); tdCor.textContent = inv.corretora || "-";
    const tdQtd = document.createElement("td"); tdQtd.textContent = quantidade ? quantidade : "-";
    const tdPM = document.createElement("td"); tdPM.textContent = formatCurrency(precoMedio);
    const tdPA = document.createElement("td"); tdPA.textContent = formatCurrency(precoAtual);
    const tdAplic = document.createElement("td"); tdAplic.textContent = formatCurrency(valorAplicado);
    const tdValAtual = document.createElement("td"); tdValAtual.textContent = formatCurrency(valorAtual);
    const tdPL = document.createElement("td"); tdPL.textContent = formatPercent(plPercent);

    const tdAcoes = document.createElement("td");
    const btnDel = document.createElement("button"); btnDel.textContent="Excluir"; btnDel.className="danger-btn";
    btnDel.onclick = async ()=>{ investimentos.splice(index,1); await salvarDados(investimentos); render(); toast("Lan√ßamento removido"); };
    tdAcoes.appendChild(btnDel);

    [tdTipo,tdTicker,tdNome,tdCor,tdQtd,tdPM,tdPA,tdAplic,tdValAtual,tdPL,tdAcoes].forEach(x=>tr.appendChild(x));
    tbody.appendChild(tr);
  });

  const totaisDiv = document.getElementById("totais");
  totaisDiv.innerHTML = "";
  let totalCarteira = 0;
  Object.entries(totais).forEach(([tipo,obj])=>{
    if(obj.aplicado>0 || obj.atual>0){
      const s = document.createElement("div");
      s.textContent = `${labelTipo(tipo)} | Aplicado: ${formatCurrency(obj.aplicado)} | Atual: ${formatCurrency(obj.atual)} | P/L: ${formatPercent(obj.aplicado ? ((obj.atual-obj.aplicado)/obj.aplicado*100):null)}`;
      totaisDiv.appendChild(s);
      totalCarteira += obj.atual;
    }
  });
  if(totalCarteira>0){
    const s2 = document.createElement("div"); s2.style.fontWeight="600"; s2.style.marginTop="6px"; s2.textContent = `Total da carteira (valor atual): ${formatCurrency(totalCarteira)}`; totaisDiv.appendChild(s2);
  }
}

/* ====== persist√™ncia/encrypt + sync ====== */
function salvarCacheLocalEncrypted(enc){
  try{ localStorage.setItem(STORAGE_KEY_ENC, enc); }catch(e){ console.warn("cache local encriptado erro", e); }
}
function carregarCacheLocalEncrypted(){ try{ return localStorage.getItem(STORAGE_KEY_ENC); }catch(e){ return null; } }

async function salvarDadosNuvem(dados){
  if(!sessionToken) { console.warn("Sem sess√£o"); return; }
  try{
    const enc = await encryptJson(dados);
    salvarCacheLocalEncrypted(enc);
    await apiPostData(enc);
  }catch(e){ console.error("erro salvar na nuvem", e); setStatus("Erro ao salvar na nuvem","error"); toast("Erro ao salvar na nuvem"); }
}

async function salvarDados(dados){
  investimentos = dados;
  // salva em background
  salvarDadosNuvem(dados);
}

/* ====== sincroniza√ß√£o inicial (busca encriptado e decripta) ====== */
async function sincronizarComNuvemAoAbrir(){
  if(!sessionToken){ setStatus("Sem sess√£o. Fa√ßa login.", ""); return; }
  setStatus("Sincronizando dados da nuvem...", "");
  try{
    const j = await apiGetData();
    if(j && j.data){
      try{
        const plain = await decryptJson(j.data);
        investimentos = Array.isArray(plain) ? plain : [];
        salvarCacheLocalEncrypted(j.data);
        render();
        setStatus("Dados sincronizados", "success");
      }catch(e){
        console.error("decrypt falhou", e);
        investimentos = [];
        render();
        setStatus("N√£o foi poss√≠vel decriptar os dados (senha errada?).", "error");
        toast("Senha n√£o corresponde aos dados criptografados. Fa√ßa login novamente.");
        showModal();
      }
    } else {
      // sem dados na nuvem: se tiver cache encriptado local e chave derivada, tenta carregar
      const cached = carregarCacheLocalEncrypted();
      if(cached && cryptoKey){
        try{
          investimentos = await decryptJson(cached);
          render();
          setStatus("Dados carregados do cache local", "success");
        }catch(e){ investimentos = []; render(); setStatus("Nenhum dado dispon√≠vel", ""); }
      } else {
        investimentos = [];
        render();
        setStatus("Sem dados na nuvem.", "");
      }
    }
  }catch(e){ console.error(e); setStatus("Erro ao sincronizar", "error"); toast("Erro ao sincronizar com a nuvem"); }
}

/* ====== validarTicker (retorna {valido, preco, nomeApi}) ====== */
async function validarTicker(tipo, ticker){
  const upper = (ticker||"").toUpperCase().trim();
  if(!upper && (tipo==="acao"||tipo==="fundo"||tipo==="cripto")) return { valido:false, msg:"Informe um ticker para esse tipo de ativo." };
  if(tipo==="cripto"){
    const info = MAPA_CRIPTO[upper];
    if(!info) return { valido:false, msg:"Cripto n√£o mapeada." };
    const res = await buscarPrecoCripto(upper);
    if(!res.valido) return { valido:false, msg:"N√£o foi poss√≠vel validar cripto." };
    return { valido:true, preco:res.preco, nomeApi:res.nomeApi };
  }
  if(tipo==="acao" || tipo==="fundo"){
    const res = await buscarPrecoAcaoOuFundo(upper);
    if(!res.valido) return { valido:false, msg:"Ticker n√£o encontrado (BRAPI)." };
    return { valido:true, preco:res.preco, nomeApi:res.nomeApi };
  }
  return { valido:true, preco:null, nomeApi:null };
}

/* ====== a√ß√µes: adicionar, atualizar pre√ßos ====== */
document.getElementById("addBtn").addEventListener("click", async ()=>{
  if(!sessionToken || !cryptoKey){ toast("Fa√ßa login antes de adicionar"); return; }
  const tipo = document.getElementById("tipo").value;
  const ticker = document.getElementById("ticker").value.trim();
  let nome = document.getElementById("nome").value.trim();
  const corretora = document.getElementById("corretora").value;
  const valor = parseFloat(document.getElementById("valor").value.replace(",","."));
  const quantidadeRaw = document.getElementById("quantidade").value.replace(",",".");
  const precoRaw = document.getElementById("preco").value.replace(",",".");
  let quantidade = quantidadeRaw ? parseFloat(quantidadeRaw) : null;
  let preco = precoRaw ? parseFloat(precoRaw) : null;

  if(!valor || isNaN(valor)){ alert("Informe o valor aplicado."); return; }
  if((tipo==="acao" || tipo==="fundo" || tipo==="cripto") && (!quantidade || isNaN(quantidade))){ alert("Informe a quantidade para a√ß√µes, fundos e cripto."); return; }

  setStatus("Validando ticker...", "");
  const valida = await validarTicker(tipo, ticker);
  if(!valida.valido){ toast(valida.msg || "Ticker inv√°lido"); setStatus(valida.msg || "Erro", "error"); return; }

  if(!nome && valida.nomeApi) nome = valida.nomeApi;
  if(!preco && valida.preco) preco = valida.preco;
  if((!quantidade || isNaN(quantidade)) && tipo==="renda_fixa") quantidade = 1;

  investimentos.push({ tipo, ticker: ticker || null, nome: nome || ticker || "", corretora, valor, quantidade, preco, criadoEm: new Date().toISOString() });
  await salvarDados(investimentos);
  render();
  toast("Lan√ßamento adicionado");
  setStatus("Lan√ßamento adicionado.", "success");

  // limpar campos
  ["ticker","nome","valor","quantidade","preco"].forEach(id=>document.getElementById(id).value="");
});

document.getElementById("updatePricesBtn").addEventListener("click", async ()=>{
  if(!sessionToken || !cryptoKey){ toast("Fa√ßa login antes de atualizar"); return; }
  if(!investimentos.length){ setStatus("Nenhum investimento para atualizar."); return; }
  setStatus("Atualizando pre√ßos...", "");
  let atualizados = 0;
  for(let inv of investimentos){
    if(!inv.ticker) continue;
    if(inv.tipo==="cripto"){
      const r = await buscarPrecoCripto(inv.ticker);
      if(r.valido && r.preco!=null){ inv.preco = r.preco; if(!inv.nome && r.nomeApi) inv.nome = r.nomeApi; atualizados++; }
    } else if(inv.tipo==="acao" || inv.tipo==="fundo"){
      const r = await buscarPrecoAcaoOuFundo(inv.ticker);
      if(r.valido && r.preco!=null){ inv.preco = r.preco; if(!inv.nome && r.nomeApi) inv.nome = r.nomeApi; atualizados++; }
    }
  }
  await salvarDados(investimentos);
  render();
  if(atualizados>0) setStatus(`Pre√ßos atualizados para ${atualizados} ativo(s).`, "success"); else setStatus("Nenhum pre√ßo atualizado.", "error");
});

/* ====== Login modal handlers ====== */
async function fazerLoginModal() {
  const userIdEl = document.getElementById("modalLoginUserId");
  const passEl = document.getElementById("modalLoginPassword");

  const userId = userIdEl ? userIdEl.value.trim() : "";
  const password = passEl ? passEl.value : "";

  if (!userId || !password) {
    alert("Informe usu√°rio e senha.");
    return;
  }

  setStatus("Autenticando...", "");

  try {
    const resp = await fetch(`${PROXY_BASE_URL}/auth/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, password }),
    });

    const text = await resp.text();
    let json;
    try { json = text ? JSON.parse(text) : null; } catch { json = null; }

    console.log("LOGIN RESPONSE:", resp.status, json || text);

    if (!resp.ok) {
      const message = (json && json.error) ? json.error : text;
      toast("Erro: " + message, 4000);
      setStatus("Falha ao autenticar: " + message, "error");
      return;
    }

    if (!json || !json.ok || !json.sessionId) {
      toast("Resposta inv√°lida do servidor.", 4000);
      setStatus("Resposta inv√°lida.", "error");
      return;
    }

    // Sucesso!
    sessionToken = json.sessionId;
    currentUserId = json.user.id;

    localStorage.setItem(SESSION_STORAGE_KEY, sessionToken);
    localStorage.setItem(USER_ID_STORAGE_KEY, currentUserId);

    try {
      cryptoKey = await deriveKey(password, json.encryptionSalt);
    } catch (e) {
      toast("Erro ao derivar chave.", 4000);
      console.error(e);
      return;
    }

    passEl.value = "";
    document.getElementById("currentUserLabel").textContent = currentUserId;

    // üéâ FECHA O MODAL AQUI (garantido)
    hideModal();

    toast("Login realizado com sucesso!", 2500);
    setStatus(`Logado como ${currentUserId}. Sincronizando...`, "success");

    await sincronizarComNuvemAoAbrir();

  } catch (err) {
    console.error("Erro de login:", err);
    toast("Erro ao conectar ao servidor.", 4000);
    setStatus("Erro de conex√£o.", "error");
  }
}


function fazerLogout(){
  sessionToken = "";
  cryptoKey = null;
  currentUserId = "";
  localStorage.removeItem(SESSION_STORAGE_KEY);
  localStorage.removeItem(USER_ID_STORAGE_KEY);
  investimentos = [];
  render();
  setStatus("Sess√£o encerrada.", "");
  document.getElementById("currentUserLabel").textContent = "n√£o logado";
  showModal();
}

/* ====== Tabs logic ====== */
function setActiveTab(tab){
  document.querySelectorAll(".tab-btn").forEach(b=>{ b.classList.toggle("active", b.getAttribute("data-tab")===tab); });
  document.querySelectorAll(".tab-content").forEach(c=>{ c.style.display = (c.id==="tab-"+tab) ? "block":"none"; });
  try{ localStorage.setItem("meus_investimentos_tab", tab); }catch(e){}
}
document.querySelectorAll(".tab-btn").forEach(btn=>btn.addEventListener("click", ()=> setActiveTab(btn.getAttribute("data-tab")) ));

/* ====== Pull to refresh (touch) ====== */
let startY = 0; let puxando = false; const mensagemPTR = document.getElementById("ptr-message");
window.addEventListener("touchstart", e => { if(window.scrollY===0){ startY = e.touches[0].clientY; puxando=true; }});
window.addEventListener("touchmove", e => { if(!puxando) return; const atualY = e.touches[0].clientY; const distancia = atualY - startY; if(distancia>50) mensagemPTR.style.display="block"; else mensagemPTR.style.display="none"; });
window.addEventListener("touchend", e => { if(!puxando) return; puxando=false; mensagemPTR.style.display="none"; const endY = e.changedTouches[0].clientY; if(endY - startY > 80){ location.reload(); } });

/* ====== attach modal buttons & enter key handling ====== */
(function attachLoginHandlers(){
  function safe(id){ return document.getElementById(id); }
  function add(){
    const loginBtn = safe("modalLoginBtn"), cancelBtn = safe("modalCancelBtn"), userInput = safe("modalLoginUserId"), passInput = safe("modalLoginPassword");
    if(!loginBtn) return console.warn("#modalLoginBtn n√£o encontrado");
    loginBtn.replaceWith(loginBtn.cloneNode(true));
    const fresh = safe("modalLoginBtn");
    fresh.addEventListener("click", async (e)=>{ e.preventDefault(); await fazerLoginModal(); });
    cancelBtn?.addEventListener("click", ()=>{ /* fechar tudo? apenas recarrega p√°gina para garantir */ location.reload(); });
    passInput?.addEventListener("keydown", (ev)=>{ if(ev.key==="Enter"){ ev.preventDefault(); fresh.click(); }});
  }
  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", add); else add();
})();

/* ====== Init on load ====== */
(async function init(){
  document.getElementById("footerAtualizacao").textContent = "√öltima vers√£o da aplica√ß√£o: " + APP_VERSION;
  // restore tab
  const st = localStorage.getItem("meus_investimentos_tab"); if(st) setActiveTab(st);
  // attach controls
  document.getElementById("openLoginModalBtn").addEventListener("click", ()=>{ document.getElementById("modalLoginUserId").value = currentUserId || ""; showModal(); });
  document.getElementById("logoutBtn").addEventListener("click", ()=>{ if(confirm("Deseja finalizar a sess√£o?")) fazerLogout(); });
  // se tiver sess√£o mas n√£o tiver key derivada, pede senha (abrir modal)
  if(!sessionToken){ showModal(); } else {
    document.getElementById("modalLoginUserId").value = currentUserId || "";
    showModal(); // pede senha para derivar chave
  }
  render();
})();

</script>
</body>
</html>
