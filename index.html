<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meus Investimentos</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f4f4f4;
      overscroll-behavior-y: contain; /* ajuda no pull-to-refresh customizado */
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 12px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 16px;
    }
    label {
      font-size: 0.85rem;
      display: block;
      margin-bottom: 4px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    #addBtn {
      background: #0f766e;
      color: #fff;
      width: 100%;
      margin-top: 4px;
    }
    #addBtn:active {
      opacity: 0.8;
    }

    .secondary-btn {
      background: #e5e7eb;
      font-size: 0.8rem;
      padding: 8px 12px;
      border-radius: 999px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      min-width: 700px;
    }
    th, td {
      padding: 6px;
      text-align: left;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
    }
    .table-container {
      overflow-x: auto;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
    }
    .tipo-renda_fixa { background: #e0f2fe; }
    .tipo-fundo      { background: #fef9c3; }
    .tipo-cripto     { background: #fee2e2; }
    .tipo-acao       { background: #dcfce7; }

    .totais span {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }
    .danger-btn {
      background: #fee2e2;
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 999px;
    }

    /* Abas */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      border-radius: 999px;
      border: 1px solid #d4d4d8;
      background: #f4f4f5;
      font-size: 0.9rem;
    }
    .tab-btn.active {
      background: #0f766e;
      color: #fff;
      border-color: #0f766e;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    .status {
      font-size: 0.8rem;
      margin-bottom: 6px;
      color: #4b5563;
    }
    .status.error {
      color: #b91c1c;
    }
    .status.success {
      color: #15803d;
    }

    /* Mensagem visual do pull-to-refresh */
    #ptr-message {
      text-align: center;
      padding: 10px;
      font-size: 0.8rem;
      color: #6b7280;
      display: none;
    }
  </style>

<style>
/* modal overlay */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.modal-hidden { display: none; }
.modal-content {
  background: #fff;
  border-radius: 12px;
  padding: 18px;
  width: min(420px, 96%);
  box-shadow: 0 12px 40px rgba(0,0,0,0.25);
}
.modal-content input { width:100%; padding:8px; margin-top:6px; border-radius:8px; border:1px solid #ddd; }
.modal-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
.primary-btn { background:#064e3b; color:white; border:none; padding:8px 12px; border-radius:8px; }
.secondary-btn { background:#e6e6e6; border:none; padding:8px 10px; border-radius:8px; }
#appOverlayBlocker { position:fixed; inset:0; background:rgba(255,255,255,0.85); z-index:900; display:none; }
</style>


</head>
<body>

<!-- bloqueador que impede interação antes do login (visível enquanto modal aberto) -->
<div id="appOverlayBlocker"></div>

<!-- Login Modal -->
<div id="loginModal" class="modal-overlay modal-hidden" role="dialog" aria-modal="true">
  <div class="modal-content" role="document">
    <h3>Entrar</h3>
    <p style="color:#6b7280; margin:6px 0 10px 0;">Faça login para acessar seus investimentos.</p>

    <label>Usuário</label>
    <input id="modalLoginUserId" placeholder="digite seu usuário" autocomplete="username"/>

    <label style="margin-top:8px;">Senha</label>
    <input id="modalLoginPassword" type="password" placeholder="sua senha" autocomplete="current-password"/>

    <div style="font-size:0.85rem; color:#6b7280; margin-top:8px;">Senha não é enviada ao servidor para armazenamento de dados — apenas usada para derivar a chave de criptografia local.</div>

    <div class="modal-actions">
      <button id="modalCancelBtn" class="secondary-btn">Cancelar</button>
      <button id="modalLoginBtn" class="primary-btn">Entrar</button>
    </div>
  </div>
</div>

  <!-- Mensagem do pull-to-refresh -->
  <div id="ptr-message">↻ Solte para atualizar a página...</div>

  <h1>Meus Investimentos</h1>
  
  
  <!-- Abas -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="cadastro">Cadastro</button>
    <button class="tab-btn" data-tab="lancamentos">Lançamentos</button>
  </div>

  <!-- ABA CADASTRO -->
  <div id="tab-cadastro" class="tab-content active">
    <div class="card">
      <h2 style="font-size:1rem; margin-top:0;">Novo lançamento</h2>

      <label for="tipo">Tipo</label>
      <select id="tipo">
        <option value="renda_fixa">Renda fixa</option>
        <option value="fundo">Fundo (FII/ETF/Fundo)</option>
        <option value="cripto">Criptoativo</option>
        <option value="acao">Ação</option>
      </select>

      <label for="ticker">Ticker / Código (para preço e validação)</label>
      <input id="ticker" placeholder="Ex.: PETR4, IVVB11, BTC, ETH..." />

      <label for="nome">Nome do ativo (deixa em branco para preencher automático)</label>
      <input id="nome" placeholder="Se vazio, usa o nome retornado pela API" />

      <label for="corretora">Corretora / Banco</label>
      <select id="corretora">
        <option value="Nubank">Nubank</option>
        <option value="XP">XP</option>
        <option value="BTG Pactual">BTG Pactual</option>
        <option value="Mercado Bitcoin">Mercado Bitcoin</option>
      </select>

      <label for="valor">Valor aplicado total (R$)</label>
      <input id="valor" type="number" step="0.01" inputmode="decimal" />

      <label for="quantidade">Quantidade de cotas/moedas</label>
      <input id="quantidade" type="number" step="0.0001" inputmode="decimal" />

      <label for="preco">Preço atual (R$) – opcional, será atualizado depois</label>
      <input id="preco" type="number" step="0.01" inputmode="decimal" />

      <button id="addBtn">Adicionar</button>
    </div>
  </div>

  <!-- ABA LANÇAMENTOS -->
  <div id="tab-lancamentos" class="tab-content">
    <div class="card">
      <div class="status" id="status"></div>
      <button id="updatePricesBtn" class="secondary-btn">Atualizar preços de mercado</button>
    </div>

    <div class="card">
      <h2 style="font-size:1rem; margin-top:0;">Totais</h2>
      <div class="totais" id="totais"></div>
    </div>

    <div class="card">
      <h2 style="font-size:1rem; margin-top:0;">Lançamentos</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Ticker</th>
              <th>Ativo</th>
              <th>Corretora</th>
              <th>Qtd</th>
              <th>Preço médio</th>
              <th>Preço atual</th>
              <th>Aplicado</th>
              <th>Valor atual</th>
              <th>P/L %</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="lista"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Rodapé com versão da aplicação -->
  <footer id="footerAtualizacao" style="
    text-align:center;
    font-size:0.75rem;
    color:#6b7280;
    margin-top:20px;
    padding-top:10px;
    border-top:1px solid #e5e7eb;
  ">
    Última versão da aplicação: carregando...
  </footer>
  
  <!-- Botão discreto para trocar de usuário (por exemplo no topo) -->
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
  <span style="font-size:0.8rem; color:#4b5563;">
    Usuário atual: <strong><span id="currentUserLabel">não logado</span></strong>
  </span>
  <button id="openLoginModalBtn" class="secondary-btn" style="font-size:0.75rem; padding:4px 8px;">
    Trocar usuário
  </button>
</div>

<!-- MODAL DE LOGIN -->
<div id="loginModal" class="modal-overlay">
  <div class="modal-content">
    <h2>Login</h2>
    <p style="font-size:0.85rem; color:#6b7280; margin-top:4px;">
      Entre com seu <strong>usuário</strong> e <strong>senha</strong>.
    </p>

    <label for="modalLoginUserId">Usuário</label>
    <input id="modalLoginUserId" placeholder="Ex.: dionatan" />

    <label for="modalLoginPassword">Senha</label>
    <input id="modalLoginPassword" type="password" placeholder="Sua senha" />

    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
      <button id="modalCancelBtn" class="secondary-btn">Cancelar</button>
      <button id="modalLoginBtn" class="primary-btn">Entrar</button>
    </div>
  </div>
</div>


  <script>
/* ====== CONFIG ====== */
const APP_VERSION = "v1.0 — secure";
const PROXY_BASE_URL = "https://proxy-brapi.dionatan-sgs.workers.dev"; // ajusta aqui
const SESSION_STORAGE_KEY = "meus_investimentos_session";
const USER_ID_STORAGE_KEY = "meus_investimentos_user_id";
const STORAGE_KEY = "meus_investimentos_v3_enc"; // armazenamos local um cache DESCRIPTOGRAFADO? opcional: keep encrypted local?
/* ====== END CONFIG ====== */

/* ====== ESTADO ====== */
let sessionToken = localStorage.getItem(SESSION_STORAGE_KEY) || "";
let currentUserId = localStorage.getItem(USER_ID_STORAGE_KEY) || "";
let cryptoKey = null; // CryptoKey (AES-GCM) - fica apenas em memória
let investimentos = []; // dados em claro na memória após decriptar

/* ====== UI helpers (modal) ====== */
function showModal() {
  document.getElementById("loginModal").classList.remove("modal-hidden");
  document.getElementById("appOverlayBlocker").style.display = "block";
}
function hideModal() {
  document.getElementById("loginModal").classList.add("modal-hidden");
  document.getElementById("appOverlayBlocker").style.display = "none";
}

/* ====== Criptografia no cliente (PBKDF2 + AES-GCM) ====== */
async function deriveKey(password, saltHex) {
  const enc = new TextEncoder();
  const passwordKey = await crypto.subtle.importKey("raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]);
  // saltHex to Uint8Array
  const salt = hexToUint8(saltHex);
  const key = await crypto.subtle.deriveKey(
    { name: "PBKDF2", salt, iterations: 200000, hash: "SHA-256" },
    passwordKey,
    { name: "AES-GCM", length: 256 },
    false,
    ["encrypt", "decrypt"]
  );
  return key;
}
function hexToUint8(hex) {
  if (!hex) return new Uint8Array();
  const res = new Uint8Array(hex.length/2);
  for (let i=0;i<res.length;i++) res[i]=parseInt(hex.substr(i*2,2),16);
  return res;
}
function uint8ToBase64(u8) {
  let s = "";
  for (let i=0;i<u8.length;i++) s+=String.fromCharCode(u8[i]);
  return btoa(s);
}
function base64ToUint8(b64) {
  const s = atob(b64);
  const u8 = new Uint8Array(s.length);
  for (let i=0;i<s.length;i++) u8[i]=s.charCodeAt(i);
  return u8;
}
async function encryptJson(obj) {
  if (!cryptoKey) throw new Error("Chave não derivada");
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const enc = new TextEncoder();
  const plain = enc.encode(JSON.stringify(obj));
  const cipher = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, cryptoKey, plain);
  const combined = new Uint8Array(iv.byteLength + cipher.byteLength);
  combined.set(iv,0);
  combined.set(new Uint8Array(cipher), iv.byteLength);
  return uint8ToBase64(combined);
}
async function decryptJson(b64) {
  if (!cryptoKey) throw new Error("Chave não derivada");
  const all = base64ToUint8(b64);
  const iv = all.slice(0,12);
  const data = all.slice(12);
  const plain = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, cryptoKey, data);
  const dec = new TextDecoder();
  return JSON.parse(dec.decode(plain));
}

/* ====== UI helpers (status, footer) ====== */
function setStatus(msg, type="") {
  const el = document.getElementById("status");
  if (!el) return;
  el.textContent = msg||"";
  el.className = "status"+(type? " "+type:"");
}
function atualizarRodape() {
  const footer = document.getElementById("footerAtualizacao");
  if (!footer) return;
  footer.textContent = "Última versão da aplicação: " + APP_VERSION;
}

/* ====== LOGIN (faz fetch /auth/login e deriva chave) ====== */
async function fazerLoginModal() {
  const userId = document.getElementById("modalLoginUserId").value.trim();
  const password = document.getElementById("modalLoginPassword").value;
  if (!userId || !password) { alert("Informe usuário e senha."); return; }
  setStatus("Autenticando...", "");
  try {
    const resp = await fetch(`${PROXY_BASE_URL}/auth/login`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ userId, password })
    });
    const json = await resp.json().catch(()=>({}));
    if (!resp.ok || !json.ok || !json.sessionId) {
      alert(json.error || "Falha ao autenticar.");
      setStatus("Falha ao autenticar.", "error");
      return;
    }
    // recebe salt para derivar chave
    const saltHex = json.encryptionSalt;
    // derive key locally
    cryptoKey = await deriveKey(password, saltHex);
    // salva sessão (token) e userId
    sessionToken = json.sessionId;
    currentUserId = json.user.id;
    localStorage.setItem(SESSION_STORAGE_KEY, sessionToken);
    localStorage.setItem(USER_ID_STORAGE_KEY, currentUserId);
    // limpa senha do input
    document.getElementById("modalLoginPassword").value = "";
    // oculta modal e sincroniza dados
    hideModal();
    setStatus(`Logado como ${currentUserId}. Sincronizando...`, "success");
    await sincronizarComNuvemAoAbrir();
  } catch (e) {
    console.error(e);
    alert("Erro ao conectar ao servidor.");
    setStatus("Erro ao conectar.", "error");
  }
}

/* ====== LOGOUT ====== */
function fazerLogout() {
  sessionToken = "";
  cryptoKey = null;
  currentUserId = "";
  localStorage.removeItem(SESSION_STORAGE_KEY);
  localStorage.removeItem(USER_ID_STORAGE_KEY);
  investimentos = [];
  render();
  setStatus("Sessão encerrada.", "");
  // abrir modal para novo login
  showModal();
}

/* ====== Sincronizar / salvar dados (criptografado) ====== */
async function sincronizarComNuvemAoAbrir() {
  if (!sessionToken) {
    setStatus("Sem sessão. Faça login.", "");
    return;
  }
  setStatus("Buscando dados criptografados...", "");
  try {
    const resp = await fetch(`${PROXY_BASE_URL}/data`, {
      headers: { Authorization: `Bearer ${sessionToken}` }
    });
    if (!resp.ok) {
      setStatus("Falha ao buscar dados da nuvem.", "error");
      return;
    }
    const json = await resp.json();
    if (json.data) {
      // decrypt
      try {
        const plain = await decryptJson(json.data);
        investimentos = plain;
        salvarCacheLocalEncrypted(json.data); // opcional cache encriptado local
        render();
        setStatus("Dados sincronizados (decriptados).", "success");
      } catch (e) {
        console.error("Erro ao decriptar:", e);
        investimentos = [];
        render();
        setStatus("Não foi possível decriptar os dados (senha errada?).", "error");
        // forçar re-login se preferir:
        showModal();
      }
    } else {
      investimentos = [];
      render();
      setStatus("Sem dados na nuvem.", "");
    }
  } catch (e) {
    console.error(e);
    setStatus("Erro ao sincronizar com a nuvem.", "error");
  }
}

// salva dados criptografados na nuvem (antes criptografa)
async function salvarDadosNuvem(dados) {
  if (!sessionToken) { console.warn("Sem sessão."); return; }
  try {
    const encrypted = await encryptJson(dados); // string base64
    // opcional: salva cache local do encriptado
    salvarCacheLocalEncrypted(encrypted);
    await fetch(`${PROXY_BASE_URL}/data`, {
      method: "POST",
      headers: { "Content-Type":"text/plain", Authorization: `Bearer ${sessionToken}` },
      body: encrypted
    });
  } catch (e) {
    console.error("Erro ao salvar na nuvem:", e);
    setStatus("Erro ao salvar na nuvem.", "error");
  }
}

/* opcional: armazenar uma cópia encriptada local para performance/offline */
function salvarCacheLocalEncrypted(encrypted) {
  try { localStorage.setItem(STORAGE_KEY, encrypted); } catch(e) { console.warn(e); }
}
function carregarCacheLocalEncrypted() {
  try { return localStorage.getItem(STORAGE_KEY); } catch(e){ return null; }
}

/* ====== salvarDados (central) ====== */
function salvarDados(dados) {
  // mantém em memória em claro
  investimentos = dados;
  // salva encriptado na nuvem (não await)
  salvarDadosNuvem(dados);
}

/* ====== Funções de UI / render da tabela (sem alteração conceitual) ====== */
/* Abaixo simplifiquei: render usa 'investimentos' em memória já decriptados */
function formatCurrency(v){ if (v==null||isNaN(v)) return "-"; return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}); }
function formatPercent(v){ if (v==null||isNaN(v)) return "-"; return v.toFixed(2).replace(".",",")+" %"; }
function labelTipo(t){ switch(t){case"renda_fixa":return"Renda fixa";case"fundo":return"Fundo";case"cripto":return"Cripto";case"acao":return"Ação";default:return t;} }

function render(){
  const tbody = document.getElementById("lista");
  if (!tbody) return;
  tbody.innerHTML="";
  const totais = { renda_fixa:{aplicado:0,atual:0},fundo:{aplicado:0,atual:0},cripto:{aplicado:0,atual:0},acao:{aplicado:0,atual:0} };
  investimentos.forEach((inv,index)=>{
    const valorAplicado = inv.valor||0;
    const quantidade = inv.quantidade||0;
    const precoAtual = inv.preco||0;
    const valorAtual = (quantidade && precoAtual)? quantidade*precoAtual : (precoAtual || valorAplicado);
    const precoMedio = (quantidade && valorAplicado)? (valorAplicado/quantidade) : (valorAplicado || null);
    const plValor = (valorAtual||0) - (valorAplicado||0);
    const plPercent = valorAplicado ? (plValor/valorAplicado)*100 : null;
    if (totais[inv.tipo]) { totais[inv.tipo].aplicado += valorAplicado; totais[inv.tipo].atual += valorAtual; }
    const tr = document.createElement("tr");
    const tdTipo = document.createElement("td"); const span=document.createElement("span"); span.textContent=labelTipo(inv.tipo); span.className="badge tipo-"+inv.tipo; tdTipo.appendChild(span);
    const tdTicker=document.createElement("td"); tdTicker.textContent=inv.ticker||"-";
    const tdNome=document.createElement("td"); tdNome.textContent=inv.nome||"-";
    const tdCorretora=document.createElement("td"); tdCorretora.textContent=inv.corretora||"-";
    const tdQtd=document.createElement("td"); tdQtd.textContent=quantidade?quantidade:"-";
    const tdPM=document.createElement("td"); tdPM.textContent=formatCurrency(precoMedio);
    const tdPrecoAtual=document.createElement("td"); tdPrecoAtual.textContent=formatCurrency(precoAtual);
    const tdAplicado=document.createElement("td"); tdAplicado.textContent=formatCurrency(valorAplicado);
    const tdValorAtual=document.createElement("td"); tdValorAtual.textContent=formatCurrency(valorAtual);
    const tdPL=document.createElement("td"); tdPL.textContent=formatPercent(plPercent);
    const tdAcoes=document.createElement("td"); const btnDel=document.createElement("button"); btnDel.textContent="Excluir"; btnDel.className="danger-btn"; btnDel.onclick=()=>{ investimentos.splice(index,1); salvarDados(investimentos); render(); }; tdAcoes.appendChild(btnDel);
    [tdTipo,tdTicker,tdNome,tdCorretora,tdQtd,tdPM,tdPrecoAtual,tdAplicado,tdValorAtual,tdPL,tdAcoes].forEach(x=>tr.appendChild(x));
    tbody.appendChild(tr);
  });
  const totaisDiv = document.getElementById("totais"); if (!totaisDiv) return; totaisDiv.innerHTML="";
  let totalCarteira=0;
  Object.entries(totais).forEach(([tipo,obj])=>{
    if (obj.aplicado>0||obj.atual>0){
      const span=document.createElement("span"); totalCarteira+=obj.atual; const plTipo = obj.aplicado? ((obj.atual-obj.aplicado)/obj.aplicado)*100 : null;
      span.textContent = `${labelTipo(tipo)} | Aplicado: ${formatCurrency(obj.aplicado)} | Atual: ${formatCurrency(obj.atual)} | P/L: ${formatPercent(plTipo)}`;
      totaisDiv.appendChild(span);
    }
  });
  if (totalCarteira>0){ const spanTotal=document.createElement("span"); spanTotal.style.marginTop="6px"; spanTotal.style.fontWeight="600"; spanTotal.textContent = "Total da carteira (valor atual): " + formatCurrency(totalCarteira); totaisDiv.appendChild(spanTotal); }
}

/* ====== Lógica de adicionar ativo (mantida, mas exige sessão) ====== */
document.getElementById("addBtn")?.addEventListener("click", async ()=>{
  if (!sessionToken || !cryptoKey) { alert("Faça login antes de adicionar lançamentos."); return; }
  const tipo = document.getElementById("tipo").value;
  const ticker = document.getElementById("ticker").value.trim();
  let nome = document.getElementById("nome").value.trim();
  const corretora = document.getElementById("corretora").value;
  const valor = parseFloat(document.getElementById("valor").value.replace(",","."));
  const quantidadeRaw = document.getElementById("quantidade").value.replace(",",".");
  const precoRaw = document.getElementById("preco").value.replace(",",".");
  let quantidade = quantidadeRaw?parseFloat(quantidadeRaw):null;
  let preco = precoRaw?parseFloat(precoRaw):null;
  if (!valor||isNaN(valor)){ alert("Informe o valor aplicado total."); return; }
  if ((tipo==="acao"||tipo==="fundo"||tipo==="cripto") && (!quantidade||isNaN(quantidade))){ alert("Para ações, fundos e cripto informe a quantidade."); return; }
  // validação externa de ticker opcional (mantém suas funções anteriores se quiser)
  investimentos.push({ tipo, ticker: ticker||null, nome: nome||ticker||"", corretora, valor, quantidade, preco, criadoEm: new Date().toISOString() });
  salvarDados(investimentos);
  alert("Lançamento adicionado com sucesso!");
  ["ticker","nome","valor","quantidade","preco"].forEach(id=>document.getElementById(id).value="");
  render();
  setStatus("Lançamento adicionado.", "success");
});

/* ====== Atualizar preços (mantém sua função existente) ====== */
/* Reaproveite suas funções buscarPrecoCripto e buscarPrecoAcaoOuFundo aqui (não incluídas por brevidade).
   Antes de rodar atualizarPrecosMercado, verifique sessionToken/cryptoKey se for necessário. */

/* ====== Inicialização ====== */
async function init() {
  atualizarRodape();
  // ligar botões modal
  document.getElementById("modalLoginBtn")?.addEventListener("click", fazerLoginModal);
  document.getElementById("modalCancelBtn")?.addEventListener("click", ()=>{ /* opcional: fechar modal */ });
  document.getElementById("openLoginModalBtn")?.addEventListener("click", ()=>{ showModal(); });
  document.getElementById("logoutBtn")?.addEventListener("click", fazerLogout);

  // se tiver sessão no localStorage, abre modal mas com userId preenchido e pede senha
  if (!sessionToken) {
    showModal();
    // opcional: preencher usuário se salvo
    document.getElementById("modalLoginUserId").value = currentUserId || "";
  } else {
    // se houver sessão, pedimos a senha para derivar chave antes de sincronizar:
    // para segurança, a sessão por si só NÃO permite decriptar os dados: precisa da senha do usuário local
    // então abrimos modal pedindo senha (userId já preenchido)
    document.getElementById("modalLoginUserId").value = currentUserId || "";
    showModal();
  }

  render();
}

init();
</script>
</body>
</html>
